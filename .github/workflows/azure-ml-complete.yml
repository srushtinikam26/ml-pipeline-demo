name: Complete ML Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - run: pip install -r requirements.txt
    - run: python -m pytest src/test_model.py -v

  train-and-register:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Install Azure CLI ML Extension
      run: az extension add -n ml -y
    
    - name: Submit Training Job
      id: submit_job
      run: |
        az ml job create --file jobs/train-job.yml \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ secrets.AZURE_ML_WORKSPACE }}
    
    - name: Register Model
      run: |
        az ml model create --name iris-classifier \
          --path azureml://jobs/${{ steps.submit_job.outputs.name }}/outputs/model \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ secrets.AZURE_ML_WORKSPACE }}